<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MJ SMART APPS â€” Admin Panel</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css" rel="stylesheet">

  <style>
    :root{
      --bg-color: #f0f2f5;
      --card-bg: #ffffff;
      --text-color: #333333;
      --muted-text: #6c757d;
      --primary-color: #5a7dff;
      --primary-dark: #4d6ce8;
      --shadow-light: rgba(0,0,0,0.08);
      --border-color: #e9ecef;
      --radius: 12px;
      font-family: 'Poppins', sans-serif;
      font-size: 16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg-color);color:var(--text-color);overflow-x:hidden}

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideInLeft {
      from { transform: translateX(-100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    /* Header */
    header.app-header{
      position:fixed;left:0;right:0;top:0;height:72px;display:flex;align-items:center;padding:0 24px;z-index:40;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 4px 12px var(--shadow-light);
      animation: fadeIn 0.5s ease-out;
    }
    header .brand{font-weight:700;font-size:20px;color:var(--primary-color); flex: 1; text-align: center;}
    header .brand span{font-weight:400;color:var(--text-color);}
    header .hamburger { cursor: pointer; display: none; transition: transform 0.2s; }
    header .hamburger:hover { transform: scale(1.1); }
    
    /* Loader Bar */
    .loader-bar {
        position: absolute;
        bottom: -1px;
        left: 0;
        width: 100%;
        height: 3px;
        background: linear-gradient(90deg, var(--primary-color), var(--primary-dark));
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease-in-out;
        z-index: 50;
    }
    .loader-bar.active {
        transform: scaleX(1);
    }
    
    /* Drawer Navigation */
    .drawer-nav {
      position: fixed;
      top: 0;
      left: -280px; /* Hidden by default */
      bottom: 0;
      width: 280px;
      background: var(--card-bg);
      padding: 24px;
      padding-top: 72px;
      box-shadow: 4px 0 16px var(--shadow-light);
      transition: left 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      z-index: 50;
    }
    .drawer-nav.open {
      left: 0;
    }
    .drawer-nav .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .drawer-nav .menu .item {
      display: flex;
      gap: 12px;
      align-items: center;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      color: var(--muted-text);
      transition: all .2s ease;
    }
    .drawer-nav .menu .item:hover, .drawer-nav .menu .item.active {
      background: var(--primary-color);
      color: #fff;
      transform: translateX(5px);
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }
    .drawer-nav .menu .item i {
      font-size: 20px;
    }
    .drawer-nav .menu .item .badge {
        background: #ff5a5a;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: auto;
    }

    /* Overlay for drawer */
    .drawer-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 49;
      display: none;
      animation: fadeIn 0.3s;
    }
    .drawer-overlay.visible {
      display: block;
    }

    /* Main layout and content */
    .container{
      display:grid;grid-template-columns:280px 1fr;gap:24px;padding:96px 24px 24px;min-height:100vh;
      transition:all .25s ease;
    }

    /* Sidebar for desktop */
    aside.sidebar{
      position:sticky;top:96px;height:calc(100vh - 120px);padding:16px;border-radius:var(--radius);
      background:var(--card-bg);box-shadow: 0 4px 16px var(--shadow-light);border:1px solid var(--border-color);
      display:flex;flex-direction:column;gap:12px;overflow:auto;
      animation: slideInLeft 0.5s ease-out;
    }
    .sidebar .menu{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .sidebar .menu .item{display:flex;gap:12px;align-items:center;padding:12px;border-radius:10px;cursor:pointer;color:var(--muted-text);transition:all .2s ease}
    .sidebar .menu .item:hover{background:var(--primary-color);color:#fff; transform: translateX(5px);}
    .sidebar .menu .item.active{background:var(--primary-color);color:#fff;box-shadow: inset 0 0 10px rgba(0,0,0,0.1); transform: translateX(5px);}
    .sidebar .menu .item i{font-size:20px}
    .sidebar .menu .item .badge {
        background: #ff5a5a;
        color: #fff;
        font-size: 12px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: auto;
    }

    /* Main area */
    main.view-area{min-height:500px; animation: fadeInUp 0.6s ease-out;}
    .top-row{display:flex;justify-content:space-between;gap:16px;align-items:center;margin-bottom:24px; animation: fadeInUp 0.7s ease-out;}
    .search{flex:1;max-width:420px;display:flex;align-items:center;background:var(--card-bg);padding:10px 16px;border-radius:var(--radius);border:1px solid var(--border-color); transition: all 0.3s; box-shadow: 0 2px 5px rgba(0,0,0,0.05);}
    .search:focus-within { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(90, 125, 255, 0.2); }
    .search input{flex:1;background:transparent;border:0;outline:none;color:var(--text-color)}

    /* Cards grid */
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
    .card{background:var(--card-bg);padding:24px;border-radius:var(--radius);border:1px solid var(--border-color);box-shadow:0 4px 16px var(--shadow-light);transition:transform .25s ease, box-shadow .25s ease; animation: fadeInUp 0.8s ease-out;}
    .card:hover{transform:translateY(-8px); box-shadow: 0 8px 24px rgba(0,0,0,0.12);}
    .card .kpi{font-size:36px;font-weight:700;color:var(--primary-color); margin-top: 8px;}
    .card .label{font-size:16px;color:var(--text-color); font-weight: 600;}
    .card .muted{font-size:14px; color: var(--muted-text);}

    /* Services cards */
    .services{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
    .service-card{display:flex;flex-direction:column;gap:12px;padding:24px;border-radius:var(--radius);background:var(--card-bg);border:1px solid var(--border-color);box-shadow: 0 4px 12px var(--shadow-light);transition:transform .2s ease, box-shadow .2s ease;}
    .service-card:hover{transform:translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,0.1);}
    .service-card .icon{height:64px;width:64px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;background:var(--primary-color);color:#fff;font-size:28px}

    /* Table */
    .table{width:100%;border-collapse:separate; border-spacing: 0 12px; margin-top:8px;}
    .table thead th{font-weight:600;text-align:left;padding:16px 12px;color:var(--muted-text);font-size:14px;border-bottom:none;position:sticky;top:0;background:var(--bg-color);z-index:20;}
    .table tbody td{padding:16px 12px;border-top:none; border-bottom:1px solid var(--border-color); background: var(--card-bg); transition: background-color 0.2s;}
    .table tbody tr:hover td {background-color: #f8f9fa;}
    .table tbody tr:first-child td { border-top: 1px solid var(--border-color); }
    .table tbody td:first-child { border-top-left-radius: var(--radius); border-bottom-left-radius: var(--radius); }
    .table tbody td:last-child { border-top-right-radius: var(--radius); border-bottom-right-radius: var(--radius); }
    .btn{padding:10px 18px;border-radius:8px;border:0;cursor:pointer;font-weight:500;transition:all .2s ease}
    .btn.primary{background:var(--primary-color);color:#fff}
    .btn.primary:hover{background:var(--primary-dark); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1);}
    .btn.ghost{background:transparent;border:1px solid var(--border-color);color:var(--text-color)}
    .btn.ghost:hover {background: var(--primary-color); color: #fff; border-color: var(--primary-color);}
    .actions{display:flex;gap:8px}
    
    /* Input and button styling for upload sections */
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 16px;
        max-width: 600px;
        margin: 0 auto;
    }
    .form-group input, .form-group textarea {
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        padding: 12px;
        border-radius: 8px;
        color: var(--text-color);
        outline: none;
        width: 100%;
        transition: border-color 0.2s;
    }
    .form-group input:focus, .form-group textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(90, 125, 255, 0.2); }
    .form-group input::placeholder, .form-group textarea::placeholder {
        color: var(--muted-text);
    }
    .form-group button {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        background: var(--primary-color);
        color: #fff;
        font-weight: 600;
        cursor: pointer;
        transition: transform .2s ease, background-color .2s ease;
    }
    .form-group button:hover {
        transform: scale(1.01);
        background: var(--primary-dark);
    }

    /* Modals */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:80; animation: fadeIn 0.3s;}
    .modal{width:100%;max-width:720px;background:var(--card-bg);padding:32px;border-radius:var(--radius);box-shadow:0 12px 40px rgba(0,0,0,0.3); animation: scaleIn 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);}
    .form-row{display:flex;gap:16px}
    .form-row .field{flex:1;display:flex;flex-direction:column;gap:8px}
    input,textarea,select{background:var(--bg-color);border:1px solid var(--border-color);padding:12px;border-radius:8px;color:var(--text-color);outline:none;width:100%; transition: border-color 0.2s;}
    input:focus, textarea:focus, select:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(90, 125, 255, 0.2); }
    input::placeholder,textarea::placeholder{color:var(--muted-text)}

    /* New popup modal */
    #popupModal{
      display:none;
      position:fixed;
      inset:0;
      z-index:100;
      background:rgba(0,0,0,0.6);
      align-items:center;
      justify-content:center;
      animation: fadeIn 0.3s;
    }
    #popupModal .popup-content{
      background:var(--card-bg);
      padding:24px;
      border-radius:var(--radius);
      max-width:400px;
      text-align:center;
      box-shadow:0 12px 40px rgba(0,0,0,0.3);
      animation: scaleIn 0.3s;
    }

    /* Responsive */
    @media (max-width:1000px){.grid{grid-template-columns:repeat(2,1fr)} .services{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:768px){
      .container { grid-template-columns: 1fr; padding: 96px 16px 24px; }
      aside.sidebar { display: none; }
      header.app-header .hamburger { display: block; }
      header.app-header .brand { margin-right: auto; margin-left: 12px; }
      header.app-header .user-info { display: none; }
      .grid, .services { grid-template-columns: 1fr; }
      .top-row{flex-direction:column;align-items:stretch}
    }
    /* Hide drawer navigation bar on larger screens */
    @media (min-width: 769px) {
      .drawer-nav, .drawer-overlay {
        display: none !important;
      }
      header.app-header .brand { margin-left: auto; margin-right: auto; }
    }

    /* small helper */
    .muted{color:var(--muted-text);font-size:14px;}

    /* Sub-views within home */
    .sub-view {
      display: none;
      margin-top: 24px;
      animation: fadeInUp 0.5s ease-out;
    }
    .sub-view.active {
      display: block;
    }
  </style>
</head>
<body>
  <header class="app-header">
    <div class="hamburger" id="hamburgerBtn" title="Toggle drawer">
      <i class="ri-menu-line"></i>
    </div>
    <div class="brand">MJ <span>SMART APPS</span></div>
    <div style="margin-left:auto; display:flex; align-items:center; gap:12px;" class="user-info">
      <div class="muted">Welcome, <span id="userName">Admin</span></div>
      <button class="btn ghost" id="logoutBtn">Logout</button>
    </div>
    <div class="loader-bar" id="loaderBar"></div>
  </header>
  
  <div class="drawer-overlay" id="drawerOverlay"></div>

  <aside class="drawer-nav" id="drawerNav">
    <nav class="menu" id="drawerMenu">
      <div class="item active" data-view="home"><i class="ri-dashboard-line"></i><div class="label">Dashboard</div></div>
      <div class="item" data-view="clients"><i class="ri-team-line"></i><div class="label">Clients</div></div>
      <div class="item" data-view="services"><i class="ri-service-line"></i><div class="label">Our Services</div></div>
      <div class="item" data-view="pricing"><i class="ri-price-tag-3-line"></i><div class="label">Pricing & Offers</div></div>
      <div class="item" data-view="messages"><i class="ri-mail-line"></i><div class="label">Messages</div><span class="badge" id="messageCountDrawer">0</span></div>
      <div class="item" data-view="updates"><i class="ri-upload-cloud-line"></i><div class="label">Updates</div></div>
    </nav>
  </aside>

  <div class="container" id="appContainer">
    <aside class="sidebar" id="sidebar">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:600">Menu</div>
      </div>
      <nav class="menu" id="sidebarMenu">
        <div class="item active" data-view="home"><i class="ri-dashboard-line"></i><div class="label">Dashboard</div></div>
        <div class="item" data-view="clients"><i class="ri-team-line"></i><div class="label">Clients</div></div>
        <div class="item" data-view="services"><i class="ri-service-line"></i><div class="label">Our Services</div></div>
        <div class="item" data-view="pricing"><i class="ri-price-tag-3-line"></i><div class="label">Pricing & Offers</div></div>
        <div class="item" data-view="messages"><i class="ri-mail-line"></i><div class="label">Messages</div><span class="badge" id="messageCountSidebar">0</span></div>
        <div class="item" data-view="updates"><i class="ri-upload-cloud-line"></i><div class="label">Updates</div></div>
      </nav>
    </aside>

    <main class="view-area">

      <section id="home" class="view">
        <div class="top-row">
          <div style="display:flex;align-items:center;gap:12px;width:100%;">
            <div class="search"><i class="ri-search-line muted"></i><input placeholder="Search clients or services..." id="searchInput"></div>
            <button class="btn primary" id="addClientQuick">+ Add Client</button>
          </div>
        </div>

        <div class="grid">
          <div class="card">
            <div class="label">Total Clients</div>
            <div class="kpi" id="kpiClients">â€”</div>
            <div class="muted">Active clients in the database</div>
          </div>

          <div class="card">
            <div class="label">Services</div>
            <div class="kpi" id="kpiServices">â€”</div>
            <div class="muted">Services offered</div>
          </div>

          <div class="card">
            <div class="label">Pricing Plans</div>
            <div class="kpi" id="kpiPricing">â€”</div>
            <div class="muted">Active pricing & offers</div>
          </div>
        </div>
        
        <div style="margin-top:24px;display:flex;gap:8px">
          <button class="btn primary" data-home-view="recent-clients">Recent Clients</button>
        </div>

        <div id="recent-clients" class="sub-view active">
          <h3 style="margin:24px 0 16px 0">Recent Clients</h3>
          <div class="card" style="padding:16px;overflow:auto">
            <table class="table" id="recentClientsTable">
              <thead>
                <tr><th>Name</th><th>Email</th><th>Phone</th><th>Service</th><th>Action</th></tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </section>

      <section id="clients" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">Clients</h2>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" id="refreshClients">Refresh</button>
            <button class="btn primary" id="openAddClient">Add Client</button>
          </div>
        </div>

        <div class="card" style="overflow-x:auto">
          <table class="table" id="clientsTable">
            <thead>
              <tr><th>Name</th><th>Email</th><th>Phone</th><th>Service</th><th>Notes</th><th>Action</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="services" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">Our Services</h2>
          <button class="btn primary" id="openAddService">Add Service</button>
        </div>
        <div class="services" id="servicesGrid">
          </div>
      </section>

      <section id="pricing" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">Pricing & Offers</h2>
          <button class="btn primary" id="openAddPricing">Add Plan</button>
        </div>
        <div class="services" id="pricingGrid"></div>
      </section>

      <section id="messages" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">Messages</h2>
        </div>
        <div class="card" style="overflow-x:auto">
          <table class="table" id="messagesTable">
            <thead>
              <tr><th>Name</th><th>Email</th><th>WhatsApp</th><th>Message</th><th>Status</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

      <section id="updates" class="view" style="display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h2 style="margin:0">Admin Updates</h2>
          <div style="display:flex;gap:8px">
            <button class="btn primary" id="openTextUpload">New Text</button>
            <button class="btn primary" id="openImageUpload">New Image</button>
          </div>
        </div>

        <div class="card" style="overflow-x:auto">
          <table class="table" id="updatesTable">
            <thead>
              <tr><th>Type</th><th>Content</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>

    </main>
  </div>

  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal" id="modalContent">
      </div>
  </div>

  <div class="modal-backdrop" id="loginBackdrop" style="display:flex;align-items:center;justify-content:center">
    <div class="modal" style="max-width:420px;padding:24px;text-align:center">
      <h2 style="margin-top:0">Welcome to MJ SMART APPS</h2>
      <p class="muted">Please enter your email and password to continue.</p>
      <div style="margin-top:16px;display:flex;flex-direction:column;gap:12px">
        <input type="email" id="loginEmail" placeholder="Your Email" required />
        <input type="password" id="loginPassword" placeholder="Your Password" required />
        <div style="display:flex;gap:12px;justify-content:center">
          <button class="btn primary" id="doLogin">Login</button>
        </div>
      </div>
    </div>
  </div>

  <div id="popupModal" style="display:none;">
    <div class="popup-content">
      <p id="popupMessage"></p>
      <button class="btn primary" id="closePopupBtn">OK</button>
    </div>
  </div>

  <script type="module">
    // IMPORTANT: replace the firebaseConfig object with your Firebase project's config.
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js';
    import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, getDocs, query, orderBy, where, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js';
    import { documentId } from 'https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js';


    const firebaseConfig = {
      apiKey: "AIzaSyA7BJzwnA6vGt9Ove2QEqMHB5ngO_N46jE",
      authDomain: "sound-7b8db.firebaseapp.com",
      databaseURL: "https://sound-7b8db-default-rtdb.firebaseio.com",
      projectId: "sound-7b8db",
      storageBucket: "sound-7b8db.firebasestorage.app",
      messagingSenderId: "950844459082",
      appId: "1:950844459082:web:210b197bc12fa114497eb3",
      measurementId: "G-K5MLYFWGW4"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // DOM refs
    const hamburgerBtn = document.getElementById('hamburgerBtn');
    const drawerNav = document.getElementById('drawerNav');
    const drawerOverlay = document.getElementById('drawerOverlay');
    const views = document.querySelectorAll('.view');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalContent = document.getElementById('modalContent');
    const loginBackdrop = document.getElementById('loginBackdrop');
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    const doLogin = document.getElementById('doLogin');
    const logoutBtn = document.getElementById('logoutBtn');
    const userNameSpan = document.getElementById('userName');
    const loaderBar = document.getElementById('loaderBar');
    const popupModal = document.getElementById('popupModal');
    const popupMessage = document.getElementById('popupMessage');
    const closePopupBtn = document.getElementById('closePopupBtn');

    // State
    let currentView = 'home';
    let clientsCol = collection(db, 'clients');
    let servicesCol = collection(db, 'services');
    let pricingCol = collection(db, 'pricing');
    let updatesCol = collection(db, 'updates');
    let messagesCol = collection(db, 'messages');

    // Drawer Navigation for mobile
    hamburgerBtn.addEventListener('click', ()=>{
      drawerNav.classList.toggle('open');
      drawerOverlay.classList.toggle('visible');
    });
    drawerOverlay.addEventListener('click', () => {
      drawerNav.classList.remove('open');
      drawerOverlay.classList.remove('visible');
    });

    // Navigation (combined for sidebar and drawer)
    const allMenuItems = document.querySelectorAll('.menu .item');
    allMenuItems.forEach(it=>{
      it.addEventListener('click', ()=>{
        // Deactivate all active items in both menus
        document.querySelectorAll('.menu .item.active').forEach(item => item.classList.remove('active'));
        // Activate the selected item in both menus based on data-view
        const view = it.getAttribute('data-view');
        document.querySelectorAll(`.menu .item[data-view="${view}"]`).forEach(item => item.classList.add('active'));

        switchView(view);
        // Close drawer after selection on mobile
        drawerNav.classList.remove('open');
        drawerOverlay.classList.remove('visible');
      });
    });

    // Sub-navigation within Home
    document.querySelectorAll('[data-home-view]').forEach(btn => {
      btn.addEventListener('click', () => {
        const homeViewName = btn.getAttribute('data-home-view');
        document.querySelectorAll('.sub-view').forEach(v => v.classList.remove('active'));
        document.getElementById(homeViewName).classList.add('active');
        document.querySelectorAll('[data-home-view]').forEach(b => b.classList.remove('primary'));
        btn.classList.add('primary');
      });
    });

    function switchView(name){
      currentView = name;
      views.forEach(v=>v.style.display='none');
      const el = document.getElementById(name);
      if(el) el.style.display='block';
      // optionally refresh view data
      if(name==='clients') fetchClients();
      if(name==='services') fetchServices();
      if(name==='pricing') fetchPricing();
      if(name==='messages') fetchMessages();
      if(name==='updates') fetchUpdates();
    }

    // Loader and Popup functions
    function showLoader() { loaderBar.classList.add('active'); }
    function hideLoader() { loaderBar.classList.remove('active'); }
    function showPopup(message) {
      popupMessage.textContent = message;
      popupModal.style.display = 'flex';
    }
    closePopupBtn.addEventListener('click', () => {
      popupModal.style.display = 'none';
    });

    // Compulsory Login with Firebase Auth
    onAuthStateChanged(auth, (user) => {
      if (user) {
        // User is signed in
        console.log('User logged in:', user.email);
        loginBackdrop.style.display = 'none';
        userNameSpan.textContent = user.email.split('@')[0];
        fetchClients();
        fetchServices();
        fetchPricing();
        fetchMessages();
        fetchUpdates();
      } else {
        // User is signed out
        console.log('User logged out.');
        loginBackdrop.style.display = 'flex';
      }
    });

    doLogin.addEventListener('click', async () => {
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();
      if (!email || !password) {
        showPopup('Email and Password are required to log in.');
        return;
      }
      showLoader();
      try {
        await signInWithEmailAndPassword(auth, email, password);
        // Auth state change listener will handle UI update
      } catch (error) {
        showPopup('Login failed: ' + error.message);
      } finally {
        hideLoader();
      }
    });

    // Logout
    logoutBtn.addEventListener('click', async () => {
      showLoader();
      try {
        await signOut(auth);
        // Auth state change listener will handle UI update
      } catch (error) {
        showPopup('Logout failed: ' + error.message);
      } finally {
        hideLoader();
      }
    });

    // Modal helpers
    function openModal(html){
      modalContent.innerHTML = html;
      modalBackdrop.style.display = 'flex';
    }
    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalContent.innerHTML = '';
    }
    modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });

    /* ------------------ Clients CRUD ------------------ */
    async function fetchClients(){
      const tbody = document.querySelector('#clientsTable tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading...</td></tr>';
      try{
        // realtime listener
        onSnapshot(clientsCol, snapshot=>{
          const rows = [];
          snapshot.forEach(docu=>{
            const d = {id:docu.id, ...docu.data()};
            rows.push(d);
          });
          renderClients(rows);
          // KPIs
          document.getElementById('kpiClients').textContent = rows.length;

          // recent clients in home
          renderRecentClients(rows.slice(0,5));
        });
      }catch(err){
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="6">Error loading clients</td></tr>';
        showPopup('Error loading clients: ' + err.message);
      }
    }

    function renderRecentClients(list){
      const tb = document.querySelector('#recentClientsTable tbody'); tb.innerHTML='';
      list.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c.name}</td><td>${c.email||'-'}</td><td>${c.phone||'-'}</td><td>${c.service||'-'}</td><td><button class="btn ghost" data-id="${c.id}" data-action="view">View</button></td>`;
        tb.appendChild(tr);
      });
    }

    function renderClients(list){
      const tbody = document.querySelector('#clientsTable tbody');
      tbody.innerHTML='';
      if(!list.length) { tbody.innerHTML='<tr><td colspan="6" class="muted">No clients yet</td></tr>'; return; }
      list.forEach(c=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${c.name}</td>
          <td>${c.email||'-'}</td>
          <td>${c.phone||'-'}</td>
          <td>${c.service||'-'}</td>
          <td>${c.notes? c.notes.substring(0,60): '-' }</td>
          <td class="actions">
            <button class="btn ghost" data-id="${c.id}" data-action="edit">Edit</button>
            <button class="btn ghost" data-id="${c.id}" data-action="delete">Delete</button>
          </td>`;
        tbody.appendChild(tr);
      });
    }

    // Open Add Client Modal
    document.getElementById('openAddClient').addEventListener('click', ()=>openAddClient());
    document.getElementById('addClientQuick').addEventListener('click', ()=>{ switchView('clients'); openAddClient(); });

    function openAddClient(data){
      const isEdit = !!data;
      openModal(`
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3>${isEdit? 'Edit' : 'Add'} Client</h3><button class='btn ghost' id='closeModal'>Close</button></div>
        <div class='form-row' style='flex-direction:column'>
          <div class='field'><label>Name</label><input id='clientName' value='${data?escapeHtml(data.name):''}' /></div>
          <div style='display:flex;gap:8px;margin-top:8px'>
            <input id='clientEmail' placeholder='Email' value='${data?escapeHtml(data.email||''):''}' />
            <input id='clientPhone' placeholder='Phone' value='${data?escapeHtml(data.phone||''):''}' />
          </div>
          <div style='display:flex;gap:8px;margin-top:8px'>
            <select id='clientService'>
              <option value='Website'>Website</option>
              <option value='Web App'>Web App</option>
              <option value='Desktop Software'>Desktop Software</option>
            </select>
          </div>
          <textarea id='clientNotes' rows='3' placeholder='Notes'>${data?escapeHtml(data.notes||''):''}</textarea>
          <div style='display:flex;gap:8px;justify-content:flex-end;margin-top:8px'>
            <button class='btn ghost' id='cancelModal'>Cancel</button>
            <button class='btn primary' id='saveClient'>${isEdit? 'Save Changes':'Add Client'}</button>
          </div>
        </div>
      `);

      // set select to value
      if(data) document.getElementById('clientService').value = data.service || 'Website';

      document.getElementById('closeModal').addEventListener('click', closeModal);
      document.getElementById('cancelModal').addEventListener('click', closeModal);
      document.getElementById('saveClient').addEventListener('click', async ()=>{
        const name = document.getElementById('clientName').value.trim();
        if(!name){showPopup('Name is required');return}
        const payload = {
          name,
          email: document.getElementById('clientEmail').value.trim(),
          phone: document.getElementById('clientPhone').value.trim(),
          service: document.getElementById('clientService').value,
          notes: document.getElementById('clientNotes').value.trim(),
          createdAt: new Date().toISOString()
        };
        showLoader();
        try{
          if(isEdit){
            const ref = doc(db, 'clients', data.id);
            await updateDoc(ref, payload);
          }else{
            await addDoc(clientsCol, payload);
          }
          closeModal();
          showPopup('Client saved successfully!');
        }catch(err){
          console.error(err);
          showPopup('Error saving client. This is likely due to Firestore Security Rules. Please update your rules to allow authenticated users to write to the database.');
        } finally {
          hideLoader();
        }
      });
    }

    // delegate client table actions
    document.querySelector('#clientsTable tbody').addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id; const action = btn.dataset.action;
      if(action==='edit'){
        showLoader();
        try{
          const snap = await getDocs(clientsCol);
          const docs = [];
          snap.forEach(d=>docs.push({id:d.id,...d.data()}));
          const found = docs.find(x=>x.id===id);
          if(found) openAddClient(found);
        }catch(e){
          console.error(e);
          showPopup('Error fetching client data.');
        }finally{
          hideLoader();
        }
      }else if(action==='delete'){
        if(confirm('Delete this client?')){
          showLoader();
          try{ await deleteDoc(doc(db,'clients',id)); showPopup('Client deleted successfully!'); }catch(e){console.error(e);showPopup('Delete failed');} finally{ hideLoader();}
        }
      }
    });

    /* ------------------ Services CRUD ------------------ */
    async function fetchServices(){
      const grid = document.getElementById('servicesGrid'); grid.innerHTML = '<div class="muted">Loading services...</div>';
      try{
        onSnapshot(servicesCol, snapshot=>{
          const list = [];
          snapshot.forEach(d=>list.push({id:d.id,...d.data()}));
          renderServices(list);
          document.getElementById('kpiServices').textContent = list.length;
        });
      }catch(err){ grid.innerHTML = '<div class="muted">Error loading services</div>'; showPopup('Error loading services: ' + err.message); }
    }

    function renderServices(list){
      const grid = document.getElementById('servicesGrid'); grid.innerHTML = '';
      if(!list.length) grid.innerHTML = '<div class="muted">No services yet</div>';
      list.forEach(s=>{
        const card = document.createElement('div'); card.className='service-card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div style="display:flex;gap:12px;align-items:center">
              <div class="icon">${escapeHtml(s.icon||s.name.charAt(0))}</div>
              <div>
                <div style="font-weight:700">${s.name}</div>
                <div class="muted" style="font-size:13px">${s.short||''}</div>
              </div>
            </div>
            <div class="actions"><button class="btn ghost" data-id="${s.id}" data-action="edit-service">Edit</button><button class="btn ghost" data-id="${s.id}" data-action="delete-service">Delete</button></div>
          </div>
          <div class="muted">${s.details? s.details.substring(0,120): ''}</div>
        `;
        grid.appendChild(card);
      });
    }

    document.getElementById('openAddService').addEventListener('click', ()=>openAddService());
    function openAddService(data){
      const edit = !!data;
      openModal(`
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3>${edit? 'Edit' : 'Add'} Service</h3><button class='btn ghost' id='closeModal2'>Close</button></div>
        <div class='form-row' style='flex-direction:column'>
          <input id='serviceName' placeholder='Service name' value='${data?escapeHtml(data.name):''}' />
          <input id='serviceShort' placeholder='Short label' value='${data?escapeHtml(data.short||''):''}' />
          <textarea id='serviceDetails' rows='4' placeholder='Describe the service'>${data?escapeHtml(data.details||''):''}</textarea>
          <div style='display:flex;gap:8px;justify-content:flex-end'>
            <button class='btn ghost' id='cancelSvc'>Cancel</button>
            <button class='btn primary' id='saveSvc'>${edit? 'Save':'Add Service'}</button>
          </div>
        </div>
      `);
      document.getElementById('closeModal2').addEventListener('click', closeModal);
      document.getElementById('cancelSvc').addEventListener('click', closeModal);
      document.getElementById('saveSvc').addEventListener('click', async ()=>{
        const name = document.getElementById('serviceName').value.trim(); if(!name) return showPopup('Name required');
        const payload = {name, short:document.getElementById('serviceShort').value.trim(), details:document.getElementById('serviceDetails').value.trim(), createdAt:new Date().toISOString() };
        showLoader();
        try{
          if(edit){ await updateDoc(doc(db,'services',data.id), payload); } else { await addDoc(servicesCol, payload); }
          closeModal();
          showPopup('Service saved successfully!');
        }catch(e){console.error(e);showPopup('Save failed');} finally { hideLoader(); }
      });
    }

    // delegate service actions
    document.getElementById('servicesGrid').addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return; const id = btn.dataset.id, action = btn.dataset.action;
      if(action==='edit-service'){
        showLoader();
        try{
          const snap = await getDocs(servicesCol); const docs=[]; snap.forEach(d=>docs.push({id:d.id,...d.data()})); const found = docs.find(x=>x.id===id); if(found) openAddService(found);
        }catch(e){ console.error(e); showPopup('Error fetching service data.'); } finally { hideLoader(); }
      }else if(action==='delete-service'){
        if(confirm('Delete service?')){ showLoader(); try{ await deleteDoc(doc(db,'services',id)); showPopup('Service deleted successfully!'); }catch(e){console.error(e); showPopup('Delete failed');} finally { hideLoader(); } }
      }
    });

    /* ------------------ Pricing CRUD ------------------ */
    async function fetchPricing(){
      const grid = document.getElementById('pricingGrid'); grid.innerHTML = '<div class="muted">Loading pricing...</div>';
      try{
        onSnapshot(pricingCol, snapshot=>{
          const list = []; snapshot.forEach(d=>list.push({id:d.id,...d.data()})); renderPricing(list); document.getElementById('kpiPricing').textContent = list.length;
        });
      }catch(err){ grid.innerHTML='<div class="muted">Error</div>'; showPopup('Error loading pricing plans: ' + err.message); }
    }

    function renderPricing(list){
      const grid = document.getElementById('pricingGrid'); grid.innerHTML='';
      if(!list.length) { grid.innerHTML = '<div class="muted">No pricing plans or offers yet.</div>'; return; }
      list.forEach(p=>grid.appendChild(makePricingCard(p)));
    }

    function makePricingCard(p){
      const el = document.createElement('div'); el.className='service-card';
      el.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800;font-size:18px">${p.name}</div>
            <div class="muted">${p.desc||''}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;font-size:20px">â‚¹ ${p.price}</div>
            <div class="muted" style="font-size:12px">${p.note||''}</div>
          </div>
        </div>
        <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
          <button class="btn ghost" data-id="${p.id}" data-action="edit-pricing">Edit</button>
          <button class="btn ghost" data-id="${p.id}" data-action="delete-pricing">Delete</button>
        </div>
      `;
      return el;
    }

    document.getElementById('openAddPricing').addEventListener('click', ()=>openAddPricing());

    function openAddPricing(data){
      const edit = !!data;
      openModal(`
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3>${edit? 'Edit':'Add'} Pricing</h3><button class='btn ghost' id='closeP'>Close</button></div>
        <div style='display:flex;flex-direction:column;gap:8px'>
          <input id='planName' placeholder='Plan name' value='${data?escapeHtml(data.name):''}' />
          <input id='planPrice' placeholder='Price in INR' value='${data?escapeHtml(data.price||''):''}' />
          <textarea id='planDesc' rows='3' placeholder='Description'>${data?escapeHtml(data.desc||''):''}</textarea>
          <div style='display:flex;justify-content:flex-end;gap:8px'><button class='btn ghost' id='cancelP'>Cancel</button><button class='btn primary' id='saveP'>${edit? 'Save':'Add Plan'}</button></div>
        </div>
      `);
      document.getElementById('closeP').addEventListener('click', closeModal);
      document.getElementById('cancelP').addEventListener('click', closeModal);
      document.getElementById('saveP').addEventListener('click', async ()=>{
        const name = document.getElementById('planName').value.trim(); if(!name) return showPopup('Name required');
        const price = document.getElementById('planPrice').value.trim()||'0';
        const payload = {name, price, desc:document.getElementById('planDesc').value.trim(), createdAt:new Date().toISOString() };
        showLoader();
        try{ if(edit){ await updateDoc(doc(db,'pricing',data.id), payload); } else { await addDoc(pricingCol, payload); } closeModal(); showPopup('Pricing plan saved successfully!'); }catch(e){console.error(e);showPopup('Save failed');} finally{ hideLoader(); }
      });
    }

    // pricing grid delegation
    document.getElementById('pricingGrid').addEventListener('click', async (ev)=>{
      const btn = ev.target.closest('button'); if(!btn) return; const id = btn.dataset.id, action = btn.dataset.action;
      if(action==='edit-pricing'){
        showLoader();
        try{ const snap = await getDocs(pricingCol); const docs=[]; snap.forEach(d=>docs.push({id:d.id,...d.data()})); const found = docs.find(x=>x.id===id); if(found) openAddPricing(found); } catch(e){ console.error(e); showPopup('Error fetching pricing data.'); } finally { hideLoader(); }
      }else if(action==='delete-pricing'){
        if(confirm('Delete plan?')){ showLoader(); try{ await deleteDoc(doc(db,'pricing',id)); showPopup('Plan deleted successfully!'); }catch(e){console.error(e);showPopup('Delete failed');} finally{ hideLoader(); } }
      }
    });

    /* ------------------ Messages CRUD ------------------ */
    async function fetchMessages(){
      const tbody = document.querySelector('#messagesTable tbody');
      tbody.innerHTML = '<tr><td colspan="6" class="muted">Loading messages...</td></tr>';
      try {
        onSnapshot(messagesCol, snapshot => {
          const messages = [];
          let unreadCount = 0;
          snapshot.forEach(docu => {
            const data = { id: docu.id, ...docu.data() };
            messages.push(data);
            if(data.status !== 'read') unreadCount++;
          });
          renderMessages(messages);
          document.getElementById('messageCountDrawer').textContent = unreadCount;
          document.getElementById('messageCountSidebar').textContent = unreadCount;
        });
      } catch(e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="6" class="muted">Error loading messages</td></tr>';
        showPopup('Error loading messages: ' + e.message);
      }
    }

    function renderMessages(list) {
      const tbody = document.querySelector('#messagesTable tbody');
      tbody.innerHTML = '';
      if(!list.length) { tbody.innerHTML='<tr><td colspan="6" class="muted">No messages yet</td></tr>'; return; }
      list.sort((a,b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0));
      list.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(m.name||'-')}</td>
          <td>${escapeHtml(m.email||'-')}</td>
          <td>${escapeHtml(m.whatsapp||'-')}</td>
          <td style="white-space:nowrap;max-width:300px;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(m.message||'-')}</td>
          <td>${escapeHtml(m.status||'unread')}</td>
          <td class="actions">
            <button class="btn ghost" data-id="${m.id}" data-action="mark-read">Mark as Read</button>
            <button class="btn ghost" data-id="${m.id}" data-action="delete-message">Delete</button>
          </td>
        `;
        if(m.status === 'read') {
          tr.style.opacity = '0.6';
          tr.querySelector('[data-action="mark-read"]').style.display = 'none';
        }
        tbody.appendChild(tr);
      });
    }

    // delegate message table actions
    document.querySelector('#messagesTable tbody').addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;

      showLoader();
      if(action === 'mark-read') {
        try {
          const messageRef = doc(db, 'messages', id);
          await updateDoc(messageRef, { status: 'read' });
          showPopup('Message marked as read.');
        } catch(e) {
          console.error(e);
          showPopup('Failed to update message status.');
        }
      } else if(action === 'delete-message') {
        if(confirm('Are you sure you want to delete this message?')) {
          try {
            await deleteDoc(doc(db, 'messages', id));
            showPopup('Message deleted successfully.');
          } catch(e) {
            console.error(e);
            showPopup('Failed to delete message.');
          }
        }
      }
      hideLoader();
    });

    /* ------------------ Updates CRUD ------------------ */
    async function fetchUpdates(){
      const tbody = document.querySelector('#updatesTable tbody');
      tbody.innerHTML = '<tr><td colspan="4" class="muted">Loading updates...</td></tr>';
      try {
        onSnapshot(query(updatesCol, orderBy('createdAt', 'desc')), snapshot => {
          const updates = [];
          snapshot.forEach(docu => {
            const data = { id: docu.id, ...docu.data() };
            updates.push(data);
          });
          renderUpdates(updates);
        });
      } catch(e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="4" class="muted">Error loading updates</td></tr>';
        showPopup('Error loading updates: ' + e.message);
      }
    }

    function renderUpdates(list) {
      const tbody = document.querySelector('#updatesTable tbody');
      tbody.innerHTML = '';
      if(!list.length) { tbody.innerHTML='<tr><td colspan="4" class="muted">No updates yet</td></tr>'; return; }
      list.forEach(u => {
        const tr = document.createElement('tr');
        let contentDisplay = u.type === 'text' ? escapeHtml(u.content).substring(0, 100) + '...' : escapeHtml(u.url).substring(0, 100) + '...';
        const date = u.createdAt ? new Date(u.createdAt.toDate()).toLocaleString() : 'N/A';
        tr.innerHTML = `
          <td>${u.type}</td>
          <td>${contentDisplay}</td>
          <td>${date}</td>
          <td class="actions">
            <button class="btn ghost" data-id="${u.id}" data-action="view-update">View</button>
            <button class="btn ghost" data-id="${u.id}" data-action="edit-update">Edit</button>
            <button class="btn ghost" data-id="${u.id}" data-action="delete-update">Delete</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Open text/image upload modals
    document.getElementById('openTextUpload').addEventListener('click', () => {
        openModal(`
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3>New Text Update</h3><button class='btn ghost' id='closeModal'>Close</button></div>
            <div class='form-row' style='flex-direction:column'>
                <textarea id="textUploadContent" rows="5" placeholder="Write your text update here..."></textarea>
                <button class="btn primary" id="textUploadBtn">Submit Text</button>
            </div>
        `);
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('textUploadBtn').addEventListener('click', async () => {
            const content = document.getElementById('textUploadContent').value.trim();
            if (!content) return showPopup('Please enter some text.');
            showLoader();
            try {
                await addDoc(updatesCol, {
                    type: 'text',
                    content: content,
                    createdAt: serverTimestamp()
                });
                closeModal();
                showPopup('Text submitted successfully!');
            } catch (e) {
                console.error(e);
                showPopup('Failed to submit text. Check your Firestore rules.');
            } finally {
                hideLoader();
            }
        });
    });

    document.getElementById('openImageUpload').addEventListener('click', () => {
        openModal(`
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3>New Image Update</h3><button class='btn ghost' id='closeModal'>Close</button></div>
            <div class='form-row' style='flex-direction:column'>
                <input type="url" id="imageUploadUrl" placeholder="Paste image URL here..." />
                <button class="btn primary" id="imageUploadBtn">Upload Image</button>
            </div>
        `);
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('imageUploadBtn').addEventListener('click', async () => {
            const url = document.getElementById('imageUploadUrl').value.trim();
            if (!url) return showPopup('Please enter an image URL.');
            showLoader();
            try {
                await addDoc(updatesCol, {
                    type: 'image',
                    url: url,
                    createdAt: serverTimestamp()
                });
                closeModal();
                showPopup('Image URL submitted successfully!');
            } catch (e) {
                console.error(e);
                showPopup('Failed to submit image URL. Check your Firestore rules.');
            } finally {
                hideLoader();
            }
        });
    });

    // delegate updates table actions
    document.querySelector('#updatesTable tbody').addEventListener('click', async (ev) => {
      const btn = ev.target.closest('button');
      if(!btn) return;
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const docRef = doc(db, 'updates', id);
      showLoader();
      if (action === 'view-update') {
          try {
              const docSnap = await getDocs(query(updatesCol, where(documentId(), '==', id)));
              if (!docSnap.empty) {
                  const data = docSnap.docs[0].data();
                  if (data.type === 'text') {
                      showPopup('Text Content: \n\n' + data.content);
                  } else if (data.type === 'image') {
                      openModal(`<div style="display:flex;flex-direction:column;gap:12px;text-align:center;">
                                    <h3>Image Update</h3>
                                    <img src="${data.url}" style="max-width:100%;height:auto;border-radius:var(--radius);" />
                                    <button class='btn ghost' id='closeModal'>Close</button>
                                  </div>`);
                      document.getElementById('closeModal').addEventListener('click', closeModal);
                  }
              }
          } catch(e) {
              console.error(e);
              showPopup('Failed to view update.');
          }
      } else if(action === 'edit-update') {
          try {
              const docSnap = await getDocs(query(updatesCol, where(documentId(), '==', id)));
              if (!docSnap.empty) {
                  const data = docSnap.docs[0].data();
                  if (data.type === 'text') {
                      openModal(`
                          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3>Edit Text Update</h3><button class='btn ghost' id='closeModal'>Close</button></div>
                          <div class='form-row' style='flex-direction:column'>
                              <textarea id="editTextContent" rows="5">${escapeHtml(data.content)}</textarea>
                              <button class="btn primary" data-id="${id}" id="saveEditBtn">Save Changes</button>
                          </div>
                      `);
                      document.getElementById('closeModal').addEventListener('click', closeModal);
                      document.getElementById('saveEditBtn').addEventListener('click', async () => {
                          const newContent = document.getElementById('editTextContent').value.trim();
                          if (!newContent) return showPopup('Text cannot be empty.');
                          showLoader();
                          try{
                            await updateDoc(docRef, { content: newContent });
                            closeModal();
                            showPopup('Update saved successfully!');
                          } catch(e){
                            console.error(e);
                            showPopup('Failed to save changes.');
                          } finally {
                            hideLoader();
                          }
                      });
                  } else if (data.type === 'image') {
                      openModal(`
                          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><h3>Edit Image URL</h3><button class='btn ghost' id='closeModal'>Close</button></div>
                          <div class='form-row' style='flex-direction:column'>
                              <input type="url" id="editImageUrl" value="${escapeHtml(data.url)}" />
                              <button class="btn primary" data-id="${id}" id="saveEditBtn">Save Changes</button>
                          </div>
                      `);
                      document.getElementById('closeModal').addEventListener('click', closeModal);
                      document.getElementById('saveEditBtn').addEventListener('click', async () => {
                          const newUrl = document.getElementById('editImageUrl').value.trim();
                          if (!newUrl) return showPopup('URL cannot be empty.');
                          showLoader();
                          try{
                            await updateDoc(docRef, { url: newUrl });
                            closeModal();
                            showPopup('Update saved successfully!');
                          } catch(e){
                            console.error(e);
                            showPopup('Failed to save changes.');
                          } finally {
                            hideLoader();
                          }
                      });
                  }
              }
          } catch(e) {
              console.error(e);
              showPopup('Failed to edit update.');
          }
      } else if(action === 'delete-update') {
        if(confirm('Are you sure you want to delete this update?')) {
          try {
            await deleteDoc(docRef);
            showPopup('Update deleted successfully!');
          } catch(e) {
            console.error(e);
            showPopup('Failed to delete update.');
          }
        }
      }
      hideLoader();
    });

    /* ------------------ Init & helpers ------------------ */
    function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;"); }
  </script>

</body>
</html>